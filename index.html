<!DOCTYPE html>
<html>
<head>
    <title>EditMode</title>
    <style>
        /* Base styles */
        :root {
            --primary-color: #2b579a;
            --toolbar-bg: #f3f2f1;
            --border-color: #e1dfdd;
            --hover-bg: #edebe9;
            --active-bg: #e1dfdd;
            --text-color: #323130;
            --button-text: #616161;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --editor-bg: white;
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --transition-speed: 0.2s;
        }

        :root[data-theme="dark"] {
            --primary-color: #4b9cff;
            --toolbar-bg: #1f1f1f;
            --border-color: #404040;
            --hover-bg: #2d2d2d;
            --active-bg: #404040;
            --text-color: #ffffff;
            --button-text: #d0d0d0;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --editor-bg: #2d2d2d;
        }

        :root[data-theme="hacker"] {
            --primary-color: #00ff00;
            --toolbar-bg: #0a0a0a;
            --border-color: #00ff00;
            --hover-bg: #1a1a1a;
            --active-bg: #2a2a2a;
            --text-color: #00ff00;
            --button-text: #00cc00;
            --shadow-color: rgba(0, 255, 0, 0.2);
            --editor-bg: #000000;
        }

        :root[data-theme="kawaii"] {
            --primary-color: #ff8dc7;
            --toolbar-bg: #fff0f7;
            --border-color: #ffcce6;
            --hover-bg: #ffe6f2;
            --active-bg: #ffd9ec;
            --text-color: #8f5c7c;
            --button-text: #b771a2;
            --shadow-color: rgba(255, 141, 199, 0.2);
            --editor-bg: #ffffff;
        }

        /* Shared styles for all themes */
        .toolbar-button,
        .menu-item,
        .file-tab,
        .view-mode-switch {
            border-radius: var(--border-radius-md);
            transition: all var(--transition-speed) ease;
        }

        .toolbar-button:hover,
        .menu-item:hover {
            transform: scale(1.05);
        }

        .spreadsheet-cell {
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-speed) ease;
        }

        .spreadsheet-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .column-header,
        .row-header,
        .corner-cell {
            border-radius: var(--border-radius-sm);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        #toolbar {
            border-radius: var(--border-radius-lg);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .dropdown-menu {
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 24px var(--shadow-color);
            border: 2px solid var(--border-color);
            padding: 8px;
        }

        .toolbar-separator {
            border-radius: 4px;
        }

        .view-mode-switch::before {
            border-radius: var(--border-radius-md);
            box-shadow: 0 2px 6px var(--shadow-color);
        }

        /* Theme-specific styles */
        :root[data-theme="dark"] .spreadsheet-cell:hover {
            background-color: var(--hover-bg);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        :root[data-theme="hacker"] .spreadsheet-cell,
        :root[data-theme="hacker"] .editor-content[contenteditable="true"] {
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        :root[data-theme="hacker"] .spreadsheet-cell:hover {
            background-color: rgba(0, 255, 0, 0.1);
            box-shadow: 0 0 12px rgba(0, 255, 0, 0.3);
        }

        :root[data-theme="hacker"] .column-header,
        :root[data-theme="hacker"] .row-header,
        :root[data-theme="hacker"] .corner-cell {
            background-color: #0a0a0a;
            border-color: #00ff00;
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.2);
        }

        :root[data-theme="hacker"] .toolbar-separator {
            background: linear-gradient(to bottom, #003300, #00ff00);
        }

        :root[data-theme="hacker"] #toolbar,
        :root[data-theme="hacker"] .dropdown-menu {
            box-shadow: 0 4px 16px rgba(0, 255, 0, 0.2);
        }

        :root[data-theme="kawaii"] .spreadsheet-cell,
        :root[data-theme="kawaii"] .editor-content[contenteditable="true"] {
            font-family: 'Comic Sans MS', 'Segoe UI', sans-serif;
        }

        :root[data-theme="kawaii"] .spreadsheet-cell:hover {
            background-color: var(--hover-bg);
        }

        :root[data-theme="kawaii"] .toolbar-separator {
            background: linear-gradient(to bottom, var(--border-color), var(--primary-color));
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: var(--text-color);
            background-color: var(--toolbar-bg);
        }

        /* Layout components */
        #file-bar {
            height: 32px;
            background-color: var(--toolbar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: stretch;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        #toolbar {
            max-width: 816px;
            margin: 20px auto 0;
            padding: 8px 16px;
            background-color: var(--editor-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            gap: 8px;
            align-items: center;
            position: sticky;
            top: 40px;
            z-index: 99;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        /* Toolbar components */
        .toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 0 8px;
        }

        .toolbar-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            color: var(--button-text);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            min-width: 32px;
            justify-content: center;
            position: relative;
        }

        .toolbar-button:active {
            background: var(--active-bg);
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 8px;
        }

        /* Dropdown and menu components */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--editor-bg);
            min-width: 200px;
            box-shadow: 0 4px 12px var(--shadow-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: none;
            z-index: 1000;
            margin-top: 4px;
            padding: 4px 0;
        }

        .dropdown-menu.show {
            display: block;
        }

        .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            font-size: 13px;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .menu-item:hover {
            color: var(--primary-color);
        }

        .menu-item:active {
            background: var(--active-bg);
        }

        .menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* File tab specific styles */
        .file-tab {
            padding: 0 16px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: var(--text-color);
            font-size: 13px;
            position: relative;
            height: 100%;
            transition: background-color var(--transition-speed) ease;
        }

        .file-tab:hover {
            background-color: var(--hover-bg);
        }

        .file-tab span {
            position: relative;
            z-index: 1;
        }

        /* Remove the existing border-right from .file-tab */
        .file-tab + .file-tab {
            margin-left: 4px;
        }

        /* Select button styles */
        select.toolbar-button {
            padding: 6px 28px 6px 12px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23616161%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px;
            color: var(--button-text);
        }

        :root[data-theme="dark"] select.toolbar-button {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d0d0d0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        }

        select.toolbar-button:hover {
            background-color: var(--hover-bg);
        }

        /* Editor styles */
        #editor {
            padding: 20px;
            height: calc(100vh - 120px);
            overflow-y: auto;
            background-color: var(--toolbar-bg);
        }

        #editor:has(.spreadsheet-view) {
            overflow: hidden;
        }

        .editor-content {
            max-width: 816px;
            margin: 0 auto;
            background: var(--editor-bg);
            padding: 72px 72px;
            min-height: 1056px;
            box-shadow: 0 2px 6px var(--shadow-color);
            outline: none;
            font-size: 11pt;
            line-height: 1.5;
            color: var(--text-color);
        }

        .editor-content.spreadsheet-view {
            max-width: none;
            padding: 0;
            min-height: auto;
        }

        /* Icon styles */
        .toolbar-button[onclick*="bold"]::before {
            content: "B";
            font-weight: bold;
        }

        .toolbar-button[onclick*="italic"]::before {
            content: "I";
            font-style: italic;
        }

        .toolbar-button[onclick*="underline"]::before {
            content: "U";
            text-decoration: underline;
        }

        .toolbar-button[onclick*="justify"]::before {
            content: "â‰¡";
            font-size: 16px;
        }

        /* Add these styles */
        .view-mode-switch {
            display: flex;
            align-items: center;
            gap: 0;
            padding: 2px;
            border-radius: 4px;
            background: var(--hover-bg);
            cursor: pointer;
            user-select: none;
            position: relative;
            width: 100px;
            height: 24px;
        }

        .view-mode-switch::before {
            content: "";
            position: absolute;
            width: 50px;
            height: 20px;
            background: var(--editor-bg);
            border-radius: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            transform: translateX(var(--slide-pos, 0));
            border: 1px solid var(--border-color);
        }

        .view-mode-switch.spreadsheet-mode::before {
            --slide-pos: 46px;
        }

        .view-mode-switch span {
            flex: 1;
            text-align: center;
            font-size: 12px;
            color: var(--button-text);
            position: relative;
            z-index: 1;
            text-transform: lowercase;
            font-weight: 500;
        }

        .view-mode-switch.spreadsheet-mode .spreadsheet-label,
        .view-mode-switch:not(.spreadsheet-mode) .doc-label {
            color: var(--primary-color);
        }

        /* Update toolbar separator margin */
        .toolbar-separator {
            margin: 0 8px;
        }

        /* Spreadsheet styles */
        .spreadsheet-wrapper {
            overflow: auto;
            width: 100%;
            height: calc(100vh - 180px);
            padding-bottom: 0;
        }

        .spreadsheet-table {
            border-collapse: collapse;
            width: auto;
            min-width: 100%;
            font-size: 11pt;
            font-family: Calibri, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--editor-bg);
        }

        .spreadsheet-cell {
            border: 1px solid var(--border-color);
            padding: 2px 4px;
            min-width: 80px;
            height: 20px;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: var(--editor-bg);
            position: relative;
            vertical-align: middle;
        }

        .spreadsheet-cell:hover {
            white-space: normal;
            word-break: break-word;
        }

        .column-header {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            padding: 2px 4px;
            min-width: 80px;
            height: 20px;
            box-sizing: border-box;
            text-align: center;
            font-weight: normal;
            position: sticky;
            top: 0;
            z-index: 1;
            font-size: 11pt;
        }

        .row-header {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            padding: 2px 4px;
            min-width: 40px;
            width: 40px;
            height: 20px;
            box-sizing: border-box;
            text-align: center;
            font-weight: normal;
            position: sticky;
            left: 0;
            z-index: 1;
            font-size: 11pt;
        }

        .corner-cell {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            min-width: 40px;
            width: 40px;
            height: 20px;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            left: 0;
            z-index: 2;
            padding: 2px 4px;
            text-align: center;
            font-weight: normal;
            font-size: 11pt;
            vertical-align: middle;
        }

        .editor-content.spreadsheet-view {
            padding: 0;
            max-width: none;
        }

        /* Add kawaii theme specific styles */
        :root[data-theme="kawaii"] .toolbar-button,
        :root[data-theme="kawaii"] .menu-item,
        :root[data-theme="kawaii"] .file-tab,
        :root[data-theme="kawaii"] .view-mode-switch {
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        :root[data-theme="kawaii"] .toolbar-button:hover,
        :root[data-theme="kawaii"] .menu-item:hover {
            background-color: var(--hover-bg);
            transform: scale(1.05);
        }

        :root[data-theme="kawaii"] .spreadsheet-cell,
        :root[data-theme="kawaii"] .editor-content[contenteditable="true"] {
            font-family: 'Comic Sans MS', 'Segoe UI', sans-serif;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        :root[data-theme="kawaii"] .spreadsheet-cell:hover {
            background-color: var(--hover-bg);
            transform: scale(1.02);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        :root[data-theme="kawaii"] .column-header,
        :root[data-theme="kawaii"] .row-header,
        :root[data-theme="kawaii"] .corner-cell {
            background-color: var(--toolbar-bg);
            border-color: var(--border-color);
            color: var(--text-color);
            font-weight: bold;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        :root[data-theme="kawaii"] #toolbar {
            border-radius: 16px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        :root[data-theme="kawaii"] .dropdown-menu {
            border-radius: 16px;
            box-shadow: 0 8px 24px var(--shadow-color);
            border: 2px solid var(--border-color);
            padding: 8px;
        }

        :root[data-theme="kawaii"] .toolbar-separator {
            background: linear-gradient(to bottom, var(--border-color), var(--primary-color));
            border-radius: 4px;
            width: 2px;
        }

        :root[data-theme="kawaii"] .view-mode-switch::before {
            border-radius: 10px;
            box-shadow: 0 2px 6px var(--shadow-color);
        }

        :root[data-theme="kawaii"] .editor-content {
            border-radius: 20px;
            box-shadow: 0 8px 24px var(--shadow-color);
        }

        /* Theme-specific corner cell styles */
        :root[data-theme="dark"] .corner-cell {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
        }

        :root[data-theme="hacker"] .corner-cell {
            background-color: #0a0a0a;
            border: 1px solid #00ff00;
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        :root[data-theme="kawaii"] .corner-cell {
            background-color: var(--toolbar-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-weight: bold;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="file-bar">
        <div class="file-tab" onclick="toggleFileMenu()">
            <span>File</span>
            <div id="fileMenu" class="dropdown-menu">
                <button class="menu-item" onclick="newDocument()">
                    <span>New</span>
                </button>
                <button class="menu-item" onclick="openFile()">
                    <span>Open...</span>
                </button>
                <button class="menu-item" onclick="saveDocument('docx')">
                    <span>Save</span>
                </button>
                <div class="menu-separator"></div>
                <button class="menu-item" onclick="saveDocument('docx')">
                    <span>Save as DOCX</span>
                </button>
                <button class="menu-item" onclick="saveDocument('xlsx')">
                    <span>Save as XLSX</span>
                </button>
                <button class="menu-item" onclick="saveDocument('pdf')">
                    <span>Export as PDF</span>
                </button>
                <button class="menu-item" onclick="saveDocument('html')">
                    <span>Export as HTML</span>
                </button>
            </div>
        </div>
        <div class="file-tab" onclick="toggleStyleMenu()">
            <span>Style</span>
            <div id="styleMenu" class="dropdown-menu">
                <button class="menu-item" onclick="setTheme('light')">
                    <span>Light Theme</span>
                </button>
                <button class="menu-item" onclick="setTheme('dark')">
                    <span>Dark Theme</span>
                </button>
                <button class="menu-item" onclick="setTheme('hacker')">
                    <span>Hacker Terminal</span>
                </button>
                <button class="menu-item" onclick="setTheme('kawaii')">
                    <span>Kawaii</span>
                </button>
            </div>
        </div>
    </div>
    <div id="toolbar">
        <div class="toolbar-group">
            <button class="toolbar-button" onclick="formatDoc('bold')" title="Bold"></button>
            <button class="toolbar-button" onclick="formatDoc('italic')" title="Italic"></button>
            <button class="toolbar-button" onclick="formatDoc('underline')" title="Underline"></button>
        </div>
        <div class="toolbar-separator"></div>
        <div class="toolbar-group">
            <select class="toolbar-button" onchange="formatDoc('fontSize', this.value)" title="Font Size">
                <option value="3">Normal</option>
                <option value="5">Large</option>
                <option value="7">Huge</option>
            </select>
        </div>
        <div class="toolbar-separator"></div>
        <div class="toolbar-group">
            <button class="toolbar-button" onclick="formatDoc('justifyLeft')" title="Align Left"></button>
            <button class="toolbar-button" onclick="formatDoc('justifyCenter')" title="Center"></button>
            <button class="toolbar-button" onclick="formatDoc('justifyRight')" title="Align Right"></button>
        </div>
        <div class="toolbar-separator"></div>
        <div class="toolbar-group">
            <div class="view-mode-switch" onclick="toggleViewMode()">
                <span class="doc-label">docx</span>
                <span class="spreadsheet-label">xlsx</span>
            </div>
        </div>
    </div>
    <div id="editor">
        <div class="editor-content" contenteditable="true"></div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const mammoth = require('mammoth');
        const XLSX = require('xlsx');

        function formatDoc(command, value = null) {
            document.execCommand(command, false, value);
        }

        function toggleFileMenu() {
            document.getElementById("fileMenu").classList.toggle("show");
            document.getElementById("styleMenu").classList.remove("show");
        }

        function toggleStyleMenu() {
            document.getElementById("styleMenu").classList.toggle("show");
            document.getElementById("fileMenu").classList.remove("show");
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.getElementById("styleMenu").classList.remove("show");
        }

        // Initialize theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        function newDocument() {
            if (confirm('Are you sure you want to create a new document? Any unsaved changes will be lost.')) {
                const editorContent = document.querySelector('.editor-content');
                window.currentWorkbook = null;
                window.currentHtmlContent = null;
                editorContent.innerHTML = '';
                editorContent.classList.remove('spreadsheet-view');
                document.querySelector('.view-mode-switch').classList.remove('spreadsheet-mode');
                editorContent.focus();
            }
        }

        function openFile() {
            ipcRenderer.send('open-file-dialog');
        }

        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            if (!event.target.closest('.file-tab')) {
                const menus = document.getElementsByClassName("dropdown-menu");
                for (const menu of menus) {
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                    }
                }
            }
        }

        function saveDocument(format) {
            const content = document.querySelector('.editor-content').innerHTML;
            ipcRenderer.send('save-file', { content, format });
        }

        function isSpreadsheet(filePath) {
            return filePath.toLowerCase().endsWith('.xlsx') || filePath.toLowerCase().endsWith('.xls');
        }

        function renderSpreadsheet(workbook) {
            let firstSheet;
            let range;
            
            if (workbook) {
                firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                range = XLSX.utils.decode_range(firstSheet['!ref'] || 'A1:Z100');
            } else {
                // Default range for empty spreadsheet - show at least 100 rows and 26 columns (A-Z)
                range = {
                    s: { r: 0, c: 0 },
                    e: { r: 99, c: 25 } // A1:Z100
                };
            }
            
            const maxCol = range.e.c;
            let actualMaxRow = range.e.r;
            
            // If we have data, find the actual last row with content
            if (firstSheet) {
                actualMaxRow = 0;
                for (let r = range.s.r; r <= range.e.r; r++) {
                    let rowHasContent = false;
                    for (let c = 0; c <= maxCol; c++) {
                        const cellRef = XLSX.utils.encode_cell({r: r, c: c});
                        if (firstSheet[cellRef]) {
                            rowHasContent = true;
                            break;
                        }
                    }
                    if (rowHasContent) {
                        actualMaxRow = r;
                    }
                }
                // Always show at least 100 rows or the content, whichever is greater
                actualMaxRow = Math.max(actualMaxRow, 99);
            }
            
            // Create a wrapper div for the spreadsheet
            const wrapper = document.createElement('div');
            wrapper.className = 'spreadsheet-wrapper';
            
            const table = document.createElement('table');
            table.className = 'spreadsheet-table';
            
            // Create column header row
            const colHeaderRow = document.createElement('tr');
            colHeaderRow.innerHTML = '<th class="corner-cell"></th>'; // Empty corner cell
            
            // Add column headers (A, B, C, etc.)
            for (let i = 0; i <= maxCol; i++) {
                const th = document.createElement('th');
                th.textContent = XLSX.utils.encode_col(i);
                th.className = 'column-header';
                colHeaderRow.appendChild(th);
            }
            table.appendChild(colHeaderRow);
            
            // Create data rows
            for (let r = range.s.r; r <= actualMaxRow; r++) {
                const row = document.createElement('tr');
                
                // Add row number
                const rowHeader = document.createElement('td');
                rowHeader.className = 'row-header';
                rowHeader.textContent = (r + 1).toString();
                row.appendChild(rowHeader);
                
                // Add cells
                for (let c = 0; c <= maxCol; c++) {
                    const cell = document.createElement('td');
                    cell.className = 'spreadsheet-cell';
                    
                    if (firstSheet) {
                        const cellRef = XLSX.utils.encode_cell({r: r, c: c});
                        const cellData = firstSheet[cellRef];
                        
                        if (cellData) {
                            // Apply cell value
                            if (cellData.w !== undefined) {
                                cell.textContent = cellData.w;
                            } else if (cellData.v !== undefined) {
                                cell.textContent = cellData.v;
                            }
                            
                            // Apply styles if present
                            if (cellData.s) {
                                // Font styles
                                if (cellData.s.font) {
                                    if (cellData.s.font.bold) cell.style.fontWeight = 'bold';
                                    if (cellData.s.font.italic) cell.style.fontStyle = 'italic';
                                    if (cellData.s.font.underline) cell.style.textDecoration = 'underline';
                                    if (cellData.s.font.name) cell.style.fontFamily = cellData.s.font.name;
                                    if (cellData.s.font.sz) cell.style.fontSize = `${cellData.s.font.sz}pt`;
                                    if (cellData.s.font.color && cellData.s.font.color.rgb) {
                                        cell.style.color = `#${cellData.s.font.color.rgb}`;
                                    }
                                }
                                
                                // Fill/background
                                if (cellData.s.fill && cellData.s.fill.fgColor && cellData.s.fill.fgColor.rgb) {
                                    cell.style.backgroundColor = `#${cellData.s.fill.fgColor.rgb}`;
                                }
                                
                                // Alignment
                                if (cellData.s.alignment) {
                                    if (cellData.s.alignment.horizontal) {
                                        cell.style.textAlign = cellData.s.alignment.horizontal;
                                    }
                                    if (cellData.s.alignment.vertical) {
                                        cell.style.verticalAlign = cellData.s.alignment.vertical;
                                    }
                                    if (cellData.s.alignment.wrapText) {
                                        cell.style.whiteSpace = 'normal';
                                    }
                                }
                                
                                // Borders
                                if (cellData.s.border) {
                                    const borderStyles = ['top', 'right', 'bottom', 'left'];
                                    borderStyles.forEach(side => {
                                        if (cellData.s.border[side]) {
                                            const border = cellData.s.border[side];
                                            const style = border.style ? 
                                                (border.style === 'thin' ? 'solid' : 
                                                 border.style === 'medium' ? 'solid' :
                                                 border.style === 'thick' ? 'solid' : 
                                                 border.style) : 'solid';
                                            const width = border.style === 'thin' ? '1px' : 
                                                         border.style === 'medium' ? '2px' :
                                                         border.style === 'thick' ? '3px' : '1px';
                                            const color = border.color && border.color.rgb ? 
                                                `#${border.color.rgb}` : 'var(--border-color)';
                                            cell.style[`border${side.charAt(0).toUpperCase() + side.slice(1)}`] = 
                                                `${width} ${style} ${color}`;
                                        }
                                    });
                                }
                            }
                        }
                    }
                    
                    row.appendChild(cell);
                }
                
                table.appendChild(row);
            }
            
            wrapper.appendChild(table);
            
            // Add the table to the wrapper
            document.querySelector('.editor-content').innerHTML = '';
            document.querySelector('.editor-content').appendChild(wrapper);
        }

        function toggleViewMode() {
            const editorContent = document.querySelector('.editor-content');
            const viewSwitch = document.querySelector('.view-mode-switch');
            const isSpreadsheetMode = !viewSwitch.classList.contains('spreadsheet-mode');
            
            viewSwitch.classList.toggle('spreadsheet-mode');
            
            if (isSpreadsheetMode) {
                editorContent.classList.add('spreadsheet-view');
                // Render empty spreadsheet if no workbook is loaded
                renderSpreadsheet(window.currentWorkbook);
            } else {
                editorContent.classList.remove('spreadsheet-view');
                // If we're switching to text mode and have HTML content stored, restore it
                if (window.currentHtmlContent) {
                    editorContent.innerHTML = window.currentHtmlContent;
                } else {
                    editorContent.innerHTML = '';
                }
            }
        }

        ipcRenderer.on('file-opened', async (event, filePath) => {
            try {
                // Clear any previous stored content
                window.currentWorkbook = null;
                window.currentHtmlContent = null;
                
                // Clear any previous view classes
                const editorContent = document.querySelector('.editor-content');
                const viewSwitch = document.querySelector('.view-mode-switch');
                
                if (isSpreadsheet(filePath)) {
                    const workbook = XLSX.readFile(filePath);
                    window.currentWorkbook = workbook; // Store the workbook
                    viewSwitch.classList.add('spreadsheet-mode');
                    editorContent.classList.add('spreadsheet-view');
                    renderSpreadsheet(workbook);
                } else {
                    editorContent.classList.remove('spreadsheet-view');
                    viewSwitch.classList.remove('spreadsheet-mode');
                    const result = await mammoth.convertToHtml({ path: filePath });
                    editorContent.innerHTML = result.value;
                    window.currentHtmlContent = result.value;
                }
            } catch (error) {
                console.error('Error opening file:', error);
                alert('Error opening file: ' + error.message);
            }
        });

        ipcRenderer.on('save-complete', (event, success) => {
            if (success) {
                alert('File saved successfully!');
            } else {
                alert('Error saving file. Please try again.');
            }
        });

        // Initialize editor
        document.querySelector('.editor-content').focus();
    </script>
</body>
</html> 